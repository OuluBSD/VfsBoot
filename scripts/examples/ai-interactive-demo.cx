#!/usr/bin/env ./codex
# Interactive AI Sub-Loop Demonstration
# Shows the new 'ai' and 'plan.discuss' interactive modes

echo "╔══════════════════════════════════════════════════════════════╗"
echo "║     Interactive AI Sub-Loop Demo                            ║"
echo "║     New Feature: Multi-turn conversations with custom prompts║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo ""

echo "This demo shows the new interactive AI functionality:"
echo ""
echo "1. COMMAND: 'ai' (without arguments)"
echo "   - Enters interactive discussion mode"
echo "   - Prompt changes to: discuss>"
echo "   - Multiple turns without repeating 'ai' command"
echo "   - Exit with: exit, back, or quit"
echo ""
echo "2. COMMAND: 'plan.discuss' (without arguments)"
echo "   - Enters plan-specific discussion mode"
echo "   - Prompt changes to: plan.discuss>"
echo "   - Shows context (current plan path and mode)"
echo "   - Exit with: exit, back, or quit"
echo ""
echo "3. COMMAND: 'ai <message>' (with arguments)"
echo "   - Single-turn AI discussion"
echo "   - Same as before (discuss mode)"
echo ""
echo "4. COMMAND: 'ai.raw <prompt>' (new)"
echo "   - Direct AI call without discuss context"
echo "   - For simple queries"
echo ""

echo "═══════════════════════════════════════════════════════════════"
echo "DEMO 1: Interactive AI Discussion (ai command)"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "Example workflow (manual interaction):"
echo ""
echo "  > ai"
echo "  📝 Started discussion session: bf145094"
echo "  💬 Entering interactive discussion mode. Type 'exit' or 'back' to return."
echo "  discuss> create hello world in c++"
echo "  🤔 Thinking..."
echo "  [AI creates plan and code...]"
echo "  discuss> now add error handling"
echo "  🤔 Thinking..."
echo "  [AI adds error handling...]"
echo "  discuss> exit"
echo "  👋 Exiting discuss mode"
echo "  >"
echo ""

echo "═══════════════════════════════════════════════════════════════"
echo "DEMO 2: Plan Discussion Mode (plan.discuss command)"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "Example workflow (manual interaction):"
echo ""
echo "  > plan.goto /plan/myproject"
echo "  > plan.discuss"
echo "  💬 Entering interactive plan discussion mode. Type 'exit' or 'back' to return."
echo "  📍 Context: /plan/myproject (forward)"
echo "  plan.discuss> add database layer"
echo "  🤔 Thinking..."
echo "  [AI suggests subplans and jobs...]"
echo "  plan.discuss> what about caching?"
echo "  🤔 Thinking..."
echo "  [AI discusses caching strategy...]"
echo "  plan.discuss> exit"
echo "  👋 Exiting plan.discuss mode"
echo "  >"
echo ""

echo "═══════════════════════════════════════════════════════════════"
echo "COMPARISON: Old vs New Workflow"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "OLD WORKFLOW (repetitive):"
echo "  > discuss create hello world"
echo "  > discuss add error handling"
echo "  > discuss add logging"
echo "  > discuss add tests"
echo ""
echo "NEW WORKFLOW (sub-loop):"
echo "  > ai"
echo "  discuss> create hello world"
echo "  discuss> add error handling"
echo "  discuss> add logging"
echo "  discuss> add tests"
echo "  discuss> exit"
echo ""

echo "═══════════════════════════════════════════════════════════════"
echo "KEY FEATURES"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "✓ Custom prompts for different modes:"
echo "  - Main prompt: >"
echo "  - Discuss mode: discuss>"
echo "  - Plan discuss mode: plan.discuss>"
echo ""
echo "✓ Context preservation:"
echo "  - Session ID maintained across turns"
echo "  - Conversation history tracked"
echo "  - Plan context shown (for plan.discuss)"
echo ""
echo "✓ Easy exit:"
echo "  - Type 'exit' to return to main prompt"
echo "  - Type 'back' to go back"
echo "  - Type 'quit' to leave sub-loop"
echo "  - Ctrl+D also works"
echo ""
echo "✓ Independent history:"
echo "  - Each sub-loop has its own command history"
echo "  - Use arrow keys to recall previous messages"
echo ""

echo "═══════════════════════════════════════════════════════════════"
echo "INTERACTIVE TEST (Try it yourself!)"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "Run these commands interactively:"
echo ""
echo "1. Test basic ai mode:"
echo "   ./codex"
echo "   > ai"
echo "   discuss> hello"
echo "   discuss> exit"
echo ""
echo "2. Test plan.discuss mode:"
echo "   ./codex"
echo "   > plan.create /plan/test root \"Test\""
echo "   > plan.goto /plan/test"
echo "   > plan.discuss"
echo "   plan.discuss> help me plan this"
echo "   plan.discuss> exit"
echo ""
echo "3. Test with cached response (if configured):"
echo "   printf 'ai create hello world\\nexit\\nexit\\n' | CODEX_AI_PROVIDER=openai ./codex"
echo ""

echo "═══════════════════════════════════════════════════════════════"
echo "NOTES FOR USERS"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "• The 'ai' command is now an alias for 'discuss'"
echo "• Use 'ai.raw' for direct AI calls without context"
echo "• Both 'ai' and 'plan.discuss' support multi-turn conversations"
echo "• Session context is preserved across turns in a sub-loop"
echo "• Sub-loops can be nested (though not recommended)"
echo ""

echo "DEMO COMPLETE"
echo ""
echo "For more information, see:"
echo "  - HOWTO_SCRIPTS.md for usage examples"
echo "  - cache/AI_CACHE_README.md for testing with cached responses"
echo "  - scripts/unittst/integration-hello-world.cx for full workflow example"
echo ""
